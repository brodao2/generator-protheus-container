# =======================================================
# Generated by "Protheus Generator <%- appVersion %>" on <%- new Date().toLocaleString() %>
# CAUTION:
# - Manual editions can be overwritten
# - Do not use in production environments
# =======================================================
FROM oraclelinux:9

LABEL version="<%- appVersion %>"
LABEL description="Generated by \"Protheus Generator\""
LABEL generated="<%= new Date().toLocaleString() %>"
LABEL author="Protheus Generator <%- appVersion %>"

################################################################################
# Prepare environment
################################################################################
USER root
ENV LD_LIBRARY_PATH=/protheus/appserver
RUN ulimit -n 32000
ENV ACCEPT_EULA=Y

# Update and install dependencies
RUN dnf update -y
RUN dnf install -y unixODBC
RUN dnf install -y openssl
RUN dnf -y install xz

# Install 7zip
RUN mkdir /tmp/7z
RUN cd /tmp/7z
RUN curl -s -L -k -O "https://7zip.org/a/7z2409-linux-x64.tar.xz"
RUN tar xf 7z*xz
RUN mv 7zzs /usr/bin/
RUN mv License.txt /usr/share/
RUN cd /
RUN rm -rf /tmp/7z
#RUN rm 7z2409-linux-x64.tar.xz
#UN rm 7zz

################################################################################
# Process Features
################################################################################
# Download features
<% downloadList.forEach(function(download) { %>
RUN mkdir -p <%= download.folder %>
RUN curl -o <%= download.folder %>/<%= download.file %> \
  <%= download.source -%>
<% }) %>

# Decompress features
<% tarList.forEach(function(decompress) { %>
RUN cd <%= decompress.folder %> \
  && tar -xzvf <%= decompress.file %> \
  && rm <%= decompress.file %>
<% }) -%>
<% zipList.forEach(function(decompress) { %>
RUN cd <%= decompress.folder %> \
  && 7zzs x -y <%= decompress.file %> \
  && rm <%= decompress.file %>
<% }) -%>

################################################################################
# Copy files
################################################################################
# Internal (image to image )
<% copyInternalList.forEach(function(copyInfo) { %>
RUN mkdir <%= copyInfo.target %>
RUN cp <%= copyInfo.source %>/*.* <%= copyInfo.target %>
#RUN if [ -e "<%= copyInfo.target %>/*.sh" ]; then \
#  fi
<% }); %>

# External (host to image )
<% copyExternalList.forEach(function(copyInfo) { %>
COPY <%= copyInfo.source %> <%= copyInfo.target %>
#RUN if [ -e "<%= copyInfo.target %>/*.sh" ]; then \
#  chmod +x <%= copyInfo.target %>/*.sh \
#  fi
<% }); %>

COPY appserver-start.sh /appserver-start.sh
RUN chmod +x ./appserver-start.sh

################################################################################
# DBAccess configuration
################################################################################
RUN /totvs/bin/dbaccess/tools/dbaccesscfg -u <%- dbUser %> -p <%- dbPassword %> \
    -d MSSQL -a SQLCONN -g "LicenseServer=<%- licenseServer %>"

################################################################################
# Final settings
################################################################################
#ENTRYPOINT [ "./appserver-start.sh" ]
CMD [ "/bin/bash" ]

#COPY ./appserver-entrypoint.sh ./start-app-server.sh
#RUN chmod +x ./start-app-server.sh
#ENTRYPOINT [ "appserver-entrypoint.sh" ]

#COPY ./tmp/dbaccess.ini /protheus/protheus_data
#RUN mkdir -p /protheus_files
#COPY ./tmp/odbc.ini /protheus_files
#COPY ./tmp/start.sh /protheus_files
#RUN chmod +x /protheus_files/start.sh
#WORKDIR /protheus_files/


<% if (exposePorts) { -%>
EXPOSE <%= exposePorts -%>
<% } -%>
