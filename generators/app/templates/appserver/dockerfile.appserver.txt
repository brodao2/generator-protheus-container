# =======================================================
# Generated by "Protheus Generator <%- appVersion %>" on <%- new Date().toLocaleString() %>
# CAUTION:
# - Manual editions can be overwritten
# - Do not use in production environments
# =======================================================
FROM oraclelinux:9

LABEL version="<%- appVersion %>"
LABEL description="Generated by \"Protheus Generator\""
LABEL generated="<%= new Date().toLocaleString() %>"
LABEL author="Protheus Generator <%- appVersion %>"

################################################################################
# Prepare environment
################################################################################
USER root

ENV export LD_LIBRARY_PATH=/totvs/bin/protheus/appserver:/totvs/bin/protheus/broker:$LD_LIBRARY_PATH
RUN ulimit -n 32000
ENV ACCEPT_EULA=Y

# Update and install dependencies
RUN dnf -y  \
  install \
  curl \
  gnupg2 \
  ca-certificates \
  xz

#  krb5-devel \
#  gcc \
#  gcc-c++ \
#  make \
#  unixODBC \
#  sudo \

<%-include('../7zip.dockerfile.txt') %>

################################################################################
# Process Features
################################################################################
# Download features
<% downloadList.forEach(function(download) { %>
RUN mkdir -p <%= download.folder %>
RUN curl -o <%= download.folder %>/<%= download.file %> \
  <%= download.source -%>
<% }) %>

# Decompress features
<% tarList.forEach(function(decompress) { %>
RUN cd <%= decompress.folder %> \
  && tar -xzvf <%= decompress.file %> \
  && rm <%= decompress.file %>
<% }) -%>
<% zipList.forEach(function(decompress) { %>
RUN cd <%= decompress.folder %> \
  && 7zzs x -y <%= decompress.file %> \
  && rm <%= decompress.file %>
<% }) -%>

################################################################################
# Copy files
################################################################################
# Internal (image to image )
<% copyInternalList.forEach(function(copyInfo) { %>
RUN mkdir -p <%= copyInfo.target %>
RUN cp -v -r <%= copyInfo.source %>/* <%= copyInfo.target %>/
<% }); %>

# External (host to image )
<% copyExternalList.forEach(function(copyInfo) { %>
COPY <%= copyInfo.source %> <%= copyInfo.target %>
<% }); %>

RUN mkdir -p /etc/init.d/totvs.d
COPY etc/init.d/* /etc/init.d/totvs.d/
RUN chmod +x /etc/init.d/totvs.d/*.sh

COPY appserver-start.sh /appserver-start.sh
RUN chmod +x /appserver-start.sh

COPY appserver-stop.sh /appserver-stop.sh
RUN chmod +x /appserver-stop.sh

<%- include('../dockerfile.tail.txt', { appVersion: appVersion }) %>

################################################################################
# Final settings
################################################################################
RUN mkdir -p /totvs/log/

ENTRYPOINT [ "/appserver-start.sh" ]

CMD [ "/bin/bash" ]

<% if (exposePorts) { -%>
EXPOSE <%= exposePorts -%>
<% } -%>
